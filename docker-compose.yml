services:
  # ZED Edge Device 1 (Main Camera)
  cv_edge:
    build:
      context: ./cv_edge
      dockerfile: Dockerfile
    container_name: edgevision_cv_edge_1
    privileged: true
    cap_add:
      - ALL
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - LD_LIBRARY_PATH=/usr/local/cuda-12.8/lib64:/usr/lib/x86_64-linux-gnu
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    devices:
      - /dev/video0:/dev/video0
      - /dev/video1:/dev/video1
      - /dev/dri:/dev/dri
    volumes:
      - ./cache:/usr/local/zed/resources
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    ports:
      - "5000:5000"
    stdin_open: true
    tty: true
    restart: unless-stopped
    networks:
      - edgevision_network

  # API Gateway - Aggregates data from multiple edge devices
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: edgevision_api_gateway
    environment:
      - SIDECAR_URL=http://localhost:9000
    ports:
      - "8000:8000"
    volumes:
      - credentials_data:/data
    restart: unless-stopped
    network_mode: host

  # Modern React Dashboard
  dashboard-react:
    build:
      context: ./dashboard-react
      dockerfile: Dockerfile
    container_name: edgevision_dashboard
    depends_on:
      - api-gateway
    ports:
      - "3000:80"
    restart: unless-stopped
    networks:
      - edgevision_network

  ts-sidecar:
    build:
      context: ./ts-sidecar
      dockerfile: Dockerfile
    container_name: ts_sidecar
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
    network_mode: host
    volumes:
      - /run/tailscale:/run/tailscale
    restart: unless-stopped

  # Legacy Streamlit Dashboard (Optional - can be removed)
  # dashboard:
  #   build:
  #     context: ./dashboard
  #     dockerfile: Dockerfile
  #   container_name: zed_dashboard_streamlit
  #   depends_on:
  #     - zed_cv_edge
  #   environment:
  #     - STREAMLIT_SERVER_HEADLESS=true
  #   ports:
  #     - "8501:8501"
  #   restart: unless-stopped
  #   networks:
  #     - zed_network

networks:
  edgevision_network:
    driver: bridge

volumes:
  credentials_data:
    driver: local
